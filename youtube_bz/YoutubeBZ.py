import html
import time
import re

from .api import YoutubeAPI, MusicBrainzAPI
from .album import Album

from difflib import SequenceMatcher

class YoutubeBZ:
    
    def find_ids(self, mbid: str)-> int:

        counts = 0
        myAlbum = Album(mbid)
        
        with open("{}.txt".format(myAlbum.title), "w") as f:
            for track in myAlbum.tracks:
                query = '+"{}" +"{}" +"{}" +"{}"'.format(
                    myAlbum.artist, myAlbum.title, 
                    track, "Auto-generated by YouTube."
                )
                response = YoutubeAPI().search(query)
                
                if 'error' in response:
                    print(response['error']['message'])
                    return 0

                video_title = html.unescape(response['items'][0]['snippet']['title'])
                video_id = response['items'][0]['id']['videoId']
                
                video_title = re.sub(r'\([^\)]+\)', '', video_title)
                track = re.sub(r'\([^\)]+\)', '', track)

                ratio = SequenceMatcher(None, track.upper(), video_title.upper()).ratio() 
                if ratio > 0.9:
                    print('{} [\033[32mOK\033[0m]'.format(video_title))
                    f.write("{}\n".format(video_id))
                    counts = counts + 1
                else:
                    print('{} [\033[33mFailed\033[0m]'.format(track))

                time.sleep(0.75)

        return counts
